/*! NamicsHomeWorkDistances 2013-11-18 */
!function(a){"use strict";function b(b){for(var c=b.split("."),d=a,e="",f=0,g=c.length;g>f;f++)e=c[f],d[e]=d[e]||{},d=d[e];return d}a.namespace=b}(window),function(a){"use strict";function b(a){this.points=[],this.center=null,this.init(a)}namespace("Lab");var c=a.Lab;b.prototype={constructor:b,init:function(a){this.addPoint(a),this.center=this.getCenter()},addPoint:function(a){this.points.push(a),this._setCenter()},_determineCenter:function(a){var b=a.length,d=0,e=0;return _.each(a,function(a){d+=a.lat,e+=a.lon}),new c.Point(d/b,e/b)},_setCenter:function(){this.center=this._determineCenter(this.points)},getCenter:function(){return this.center},getPoints:function(){return this.points}},c.Cluster=b}(window),function(){"use strict";function a(a){this.init(a)}namespace("Lab"),a.prototype={constructor:a,init:function(a){this.address=a.Adresse_H,this.birthYear=a.Birth,this.country=a.Land_H,this.city=a.Ort_H,this.postalCode=a.PLZ_H,this.startAtNamics=a.Start_N,this.geo=new Lab.Point(a.geo_latitude,a.geo_longitude),this.workCity=a.Ort_A,this.workPostalCode=a.PLZ_A,this.workGeo=new Lab.Point(a.geo_latitude_A,a.geo_longitude_A),this.distanceToWork=this._calculateDistanceToWork(this.geo,this.workGeo)},_calculateDistanceToWork:function(a,b){var c=new LatLon(a.lat,a.lon),d=new LatLon(b.lat,b.lon);return parseFloat(c.distanceTo(d))},getDistanceToWork:function(){return this.distanceToWork}},Lab.Employee=a}(window),function(){"use strict";function a(a){this.collection=[],this.init(a)}namespace("Lab"),a.prototype={constructor:a,init:function(a){this.json=a;for(var b=0,c=a.length;c>b;b++)this.collection.push(new Lab.Employee(a[b].properties))},getCollection:function(){return this.collection},getSize:function(){return this.collection.length},getMaximumDistanceToWork:function(){}},Lab.EmployeeCollection=a}(window),function(a,b){"use strict";function c(a,b,c){this.init(a,b,c)}namespace("Lab");var d=b.Lab;c.prototype={constructor:c,init:function(a,b,c){this.name=a,this.point=new d.Point(b,c),this.id=b+","+c},getName:function(){return this.name},getPoint:function(){return this.point},getId:function(){return this.id}},d.OfficeLocation=c}(jQuery,window),function(a){"use strict";function b(a,b){this.init(a,b)}namespace("Lab");var c=a.Lab;b.prototype={constructor:b,init:function(a,b){this.lat=a,this.lon=b},toString:function(){return this.lat+","+this.lon}},c.Point=b}(window),function(a){"use strict";function b(){}namespace("Lab"),b.prototype={constructor:b,init:function(){}},a.Lab=a.Lab||{},a.Lab.WorkPlace=b}(window),function(a,b){"use strict";var c=b.Lab;Tc.Module.NxOpenData=Tc.Module.extend({clusterDistance:1,mapCenter:{lat:47.3647388,lon:8.5312022},clusters:[],clusterWorkConnections:[],map:null,peopleLocationData:null,formattedClusterWorkConnections:[],koModel:{},namicsOffices:{},averageDistanceLayers:[],on:function(b){var d=this,e=d.$ctx,f=e.data("namics-ppl-locations"),g=e.data("namics-offices");d.tmplfullDataTable=doT.template(a("#tmpl-FullDataTable").html()),d.tmplByCompetence=doT.template(a("#tmpl-ByCompetence").html()),d.tmplOfficeNavigation=doT.template(a("#tmpl-OfficeNavigation").html()),d.koModel={clusterDistance:ko.observable(),numberOfEmployees:ko.observable(),employeeClusters:ko.observable(),clusterWorkConnections:ko.observable(),minDistance:ko.observable(),maxDistance:ko.observable(),radioSelectedOptionValue:ko.observable(d.clusterDistance),showAverageDistance:ko.observable()},d.koModel.radioSelectedOptionValue.subscribe(function(a){d.clusterDistance=parseFloat(a),d.resetMap()}),d.koModel.showAverageDistance.subscribe(function(a){a===!0?d.showAverageDistanceLayer():d.hideAverageDistanceLayer()}),e.on("dataready",function(){d.workPlaceMappings=_.groupBy(d.peopleLocationData,function(a){return a.properties.geo_latitude_A+","+a.properties.geo_longitude_A}),_.each(d.workPlaceMappings,function(b,c){var e=b.length,f=d.namicsOffices[c].point,g=0;_.each(b,function(a){var b=a.properties.geo_latitude,c=a.properties.geo_longitude;g+=d.calculateDistance(f.lat,f.lon,b,c)}),a.extend(b,{totalDistanceRounded:Math.round(100*g)/100,averageDistanceRounded:Math.round(g/e*100)/100})}),d.workPlaces=_.map(d.workPlaceMappings,function(a,b){var d=b.split(",");return{workPlacePoint:new c.Point(d[0],d[1]),employees:a.length,totalDistanceRounded:a.totalDistanceRounded,averageDistanceRounded:a.averageDistanceRounded}}),d.addAverageDistanceLayers(),d.koModel.numberOfEmployees(d.employeeCollection.getSize()),d.minDistance=d.getMinDistance(d.peopleLocationData),d.maxDistance=d.getMaxDistance(d.peopleLocationData),d.koModel.minDistance(d.minDistance),d.koModel.maxDistance(d.maxDistance),d.initMapWidget()}),e.on("dataavailable",function(a,b,f){d.peopleLocationData=b,d.prepareOfficeLocationData(f),d.employeeCollection=new c.EmployeeCollection(b),e.trigger("dataready")}),e.on("click",".widget-map-navigation button",function(){var b=a(this).data("lat"),c=a(this).data("lon");d.map.panTo(new L.LatLng(b,c))}),e.on("click",".show-all",function(){var a=_.map(d.namicsOffices,function(a){return[a.point.lat,a.point.lon]});d.map.fitBounds(a)}),a.when(a.getJSON(f),a.getJSON(g)).done(function(a,b){var c=a[0],e=b[0];d.$ctx.trigger("dataavailable",[c.features,e])}),ko.applyBindings(d.koModel,e[0]),b()},addAverageDistanceLayers:function(){var a=this;_.each(a.workPlaces,function(b){var c=b.workPlacePoint.lat,d=b.workPlacePoint.lon,e=new L.circle(new L.LatLng(c,d),1e3*b.averageDistanceRounded,{color:"#f00",opacity:.3,weight:5,fill:!1,stroke:!0});a.averageDistanceLayers.push(e),e.bindPopup("Durschnittliche Distanz in Km (Luftweg): "+b.averageDistanceRounded)})},prepareOfficeLocationData:function(a){var b=this,d=b.$ctx;_.each(a,function(a){var d=new c.OfficeLocation(a.name,a.point[0],a.point[1]);b.namicsOffices[d.getId()]={name:d.getName(),point:d.getPoint()}});var e=_.map(b.namicsOffices,b.namicsOfficeMapper);d.find(".widget-map-navigation").html(b.tmplOfficeNavigation(e))},namicsOfficeMapper:function(a){return{point:a.point,name:a.name}},resetMap:function(){{var a=this;a.$ctx}a.clusterWorkConnectionLayer.clearLayers(),a.clusterLocationLayer.clearLayers(),a.workLocationLayer.clearLayers(),a.clusters=[],a.clusterWorkConnections=[],a.initMapWidget()},initMapWidget:function(){var b=this,c=(b.$ctx,b.peopleLocationData);_.each(c,a.proxy(b.createClusterAndWorkConnections,b));var d=_.groupBy(b.clusterWorkConnections,function(a){return a.workPoint+";"+a.cluster.getCenter()});b.formattedClusterWorkConnections=_.map(d,function(a){return{workPoint:a[0].workPoint,clusterCenter:a[0].cluster.getCenter(),connections:a.length}}),null===b.map&&b.initMap(),b.koModel.employeeClusters(b.clusters.length),b.koModel.clusterDistance(b.clusterDistance),b.koModel.clusterWorkConnections(b.formattedClusterWorkConnections.length),_.each(b.formattedClusterWorkConnections,function(a){b.addClusterWorkConnection(b.map,a.clusterCenter,a.workPoint,a.connections)}),b.clusterWorkConnectionLayer.addTo(b.map),_.each(b.clusters,function(a){b.addClusterLocation(b.map,a.getCenter(),a.getPoints().length)}),b.clusterLocationLayer.addTo(b.map),_.each(b.formattedClusterWorkConnections,function(a){b.addWorkLocation(b.map,a.workPoint)}),b.workLocationLayer.addTo(b.map)},showAverageDistanceLayer:function(){var a=this;_.each(a.averageDistanceLayers,function(b){a.averageDistanceLayer.addLayer(b)}),a.averageDistanceLayer.addTo(a.map)},hideAverageDistanceLayer:function(){var a=this;a.averageDistanceLayer.clearLayers()},getMinDistance:function(a){var b=this,c=_.min(a,function(a){var c=a.properties,d=b.calculateDistance(c.geo_latitude_A,c.geo_longitude_A,c.geo_latitude,c.geo_longitude);return parseFloat(d)});return b.calculateDistance(c.properties.geo_latitude_A,c.properties.geo_longitude_A,c.properties.geo_latitude,c.properties.geo_longitude)},getMaxDistance:function(a){var b=this,c=_.max(a,function(a){var c=a.properties,d=b.calculateDistance(c.geo_latitude_A,c.geo_longitude_A,c.geo_latitude,c.geo_longitude);return parseFloat(d)});return b.calculateDistance(c.properties.geo_latitude_A,c.properties.geo_longitude_A,c.properties.geo_latitude,c.properties.geo_longitude)},createClusterAndWorkConnections:function(a){var b=this,d=a.properties.geo_latitude,e=a.properties.geo_longitude,f=new c.Point(d,e),g=null,h=b.findClusterWithinDistance(f,b.clusterDistance);if(null===h){var i=new c.Cluster(f);b.clusters.push(i),g=i}else h.addPoint(f),g=h;return b.clusterWorkConnections.push({cluster:g,workPoint:new c.Point(a.properties.geo_latitude_A,a.properties.geo_longitude_A)}),{clusters:b.clusters,clusterWorkConnections:b.clusterWorkConnections}},initMap:function(){var a,b=this;null===b.map&&(b.map=new L.Map("map"));var c="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",d="Map data Â© OpenStreetMap contributors";a=new L.TileLayer(c,{minZoom:6,maxZoom:18,attribution:d}),a=L.tileLayer.provider("Nokia.normalGreyDay"),b.map.addLayer(a),b.clusterLocationLayer=new L.layerGroup,b.clusterWorkConnectionLayer=new L.layerGroup,b.workLocationLayer=new L.layerGroup,b.averageDistanceLayer=new L.layerGroup,b.map.setView(new L.LatLng(b.mapCenter.lat,b.mapCenter.lon),12)},getEmployeeNumberByWorkLocation:function(a){var b=a.lat+","+a.lon;return this.workPlaceMappings[b].length},addClusterLocation:function(a,b,c){var d=this,e=500,f=Math.log(c),g=L.circle([b.lat,b.lon],e*f,{color:"#0093c1",fillColor:"#63c2d8",fillOpacity:.5});d.clusterLocationLayer.addLayer(g),g.bindPopup("Leute die hier wohnen: "+c)},addWorkLocation:function(a,b){var c=this,d=L.circle([b.lat,b.lon],300,{color:"#f99b00",fillColor:"#f9b300",fillOpacity:1});c.workLocationLayer.addLayer(d),d.bindPopup(c.namicsOffices[b.lat+","+b.lon].name+". Mitarbeiter. "+c.getEmployeeNumberByWorkLocation(b))},addClusterWorkConnection:function(a,b,c,d){var e=this,f=2,g=Math.log(d),h=.5+.1*g,i=L.polyline([[b.lat,b.lon],[c.lat,c.lon]],{weight:1.2+f*g,opacity:h,color:"#00539e"});e.clusterWorkConnectionLayer.addLayer(i)},getNamicsColor:function(a){return 2>a?"#63C2D8":11>a?"#0093C1":"#00539E"},calculateDistance:function(a,b,c,d){var e=new LatLon(a,b),f=new LatLon(c,d);return parseFloat(e.distanceTo(f))},findClusterWithinDistance:function(a,b){for(var c=this,d=0,e=c.clusters.length;e>d;d++){var f=c.clusters[d].getCenter();if(c.calculateDistance(a.lat,a.lon,f.lat,f.lon)<=b)return c.clusters[d]}return null},generateFullTable:function(a,b){var c=this,d=c.$ctx;d.find(".widget-table").html(c.tmplfullDataTable(b))},generateCompetenceTable:function(a,b){var c=this,d=c.$ctx,e=_.countBy(b,function(a){return a.properties.Kompetenz}),f=[];_.each(e,function(a,b){f.push({competence:b,count:a})}),d.find(".widget-competence").html(c.tmplByCompetence(f))}})}(Tc.$,window),function(a){a(document).ready(function(){var b=a("html"),c=new Tc.Application(b);c.registerModules(),c.start()})}(Tc.$);